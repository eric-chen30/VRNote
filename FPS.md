本教程将从头开始制作一个FPS游戏

使用到的Unreal版本是5.0.x



# 场景配置

## 导入素材

在虚幻市场中下载这个场景，并将之添加到初始项目里

![image-20220929221412057](assets/image-20220929221412057.png)

将示例场景中的Demo_Scene复制到自己创建的Maps文件夹中，取名为FPS_Level

**![image-20220929222026912](assets/image-20220929222026912.png)**

打开这个地图的关卡蓝图

![image-20220929222101289](assets/image-20220929222101289.png)

把下面这一段都删掉

![image-20220929222136688](assets/image-20220929222136688.png)

然后把这个电影序列也删掉

![image-20220929222157999](assets/image-20220929222157999.png)



## 创建天空

首先把目前几个能发光的都删掉

![image-20220929222624080](assets/image-20220929222624080.png)

添加天空大气和定向光源

![image-20220929222914195](assets/image-20220929222914195.png)

![image-20220929222923706](assets/image-20220929222923706.png)

再放一个天空盒进来

![image-20220929223331617](assets/image-20220929223331617.png)

加点云进来

![image-20220929223437850](assets/image-20220929223437850.png)

把天空盒链接上自己的定向光源

![image-20220929223542051](assets/image-20220929223542051.png)

还可以调星星的亮度

![image-20220929223705635](assets/image-20220929223705635.png)

如果此时你按ctrl+L，把太阳放下去，会发现整个场景一片漆黑，此时就说明需要加一个天光进来

![image-20220929223849803](assets/image-20220929223849803.png)

把太阳放下去，让天空变暗，然后调大天光的强度范围

![image-20220929224234796](assets/image-20220929224234796.png)

找到全局后期处理体积，把lens flares的强度取消，这样镜头前就不会出现光晕

![image-20220929224611571](assets/image-20220929224611571.png)

取消自动曝光

![image-20220929225025841](assets/image-20220929225025841.png)

复制一下外面的地面，把胡同口堵住，形成一堵墙

![image-20220929225715703](assets/image-20220929225715703.png)



## 添加素材

再添加两个资源到项目里

![image-20220929232028270](assets/image-20220929232028270.png)

![image-20220929232042549](assets/image-20220929232042549.png)

整理一下文件结构

![image-20220929235340280](assets/image-20220929235340280.png)

删掉多余资产

![image-20220929235939416](assets/image-20220929235939416.png)

![image-20220930201207579](assets/image-20220930201207579.png)

![image-20220930201331698](assets/image-20220930201331698.png)

![image-20220930201421579](assets/image-20220930201421579.png)

打开这个网格体

**![image-20220930201625663](assets/image-20220930201625663.png)**

![image-20220930201650477](assets/image-20220930201650477.png)

创建一个文件夹

![image-20220930201834612](assets/image-20220930201834612.png)

移动文件夹

![image-20220930201901213](assets/image-20220930201901213.png)

![image-20220930201945212](assets/image-20220930201945212.png)

你会发现就算移过去，这个文件夹还是存在，这是由于重定向的一些问题，我们需要修复它

![image-20220930202231291](assets/image-20220930202231291.png)

下面的ParagonLtBelica也是一样，这两个文件夹修复完之后就可以直接删掉了

这是最终的项目目录

![image-20220930202401339](assets/image-20220930202401339.png)



# 人物塑造

创建如下目录，并创建一个角色蓝图

![image-20220930204737677](assets/image-20220930204737677.png)

添加一个摄像机

![image-20220930223920474](assets/image-20220930223920474.png)

选中网格体，并调整到合适的位置

![image-20220930223956244](assets/image-20220930223956244.png)

编译保存之后，把这个角色蓝图拖到场景里，设置自动控制玩家

![image-20220930222154552](assets/image-20220930222154552.png)



## 位置移动

打开项目设置，添加输入事件

![image-20220930225402623](assets/image-20220930225402623.png)

在FPS_Character中编写如下蓝图

![image-20220930225425752](assets/image-20220930225425752.png)

编译运行，你就可以用键盘控制玩家的移动了



## **控制视角**

![image-20220930230159102](assets/image-20220930230159102.png)

![image-20220930230210990](assets/image-20220930230210990.png)

![image-20220930230422098](assets/image-20220930230422098.png)

## **跳跃**

![image-20221001071047355](assets/image-20221001071047355.png)

![image-20221001071056965](assets/image-20221001071056965.png)

可以自由控制跳跃的相关参数

![image-20221001072103408](assets/image-20221001072103408.png)

## **动画**

创建文件夹，并新建一个动画蓝图，并命名为FPS_AnimBP

![image-20221001091626537](assets/image-20221001091626537.png)

![image-20221001091923523](assets/image-20221001091923523.png)

回到FPS_Character，点击网格体，使用我们自己的动画蓝图

![image-20221001092302041](assets/image-20221001092302041.png)

**开始配置动画**

放一个状态机，添加一个变量

![image-20221001094127183](assets/image-20221001094127183.png)

添加两个状态

![image-20221001094146682](assets/image-20221001094146682.png)

从右下角的资产浏览器里取动画资产

![image-20221001094324053](assets/image-20221001094324053.png)

Idle状态

![image-20221001094247378](assets/image-20221001094247378.png)

Walking状态![image-20221001094304322](assets/image-20221001094304322.png)

Idle到Walking的规则

![image-20221001094203898](assets/image-20221001094203898.png)

Walking到Idle的规则

![image-20221001094225145](assets/image-20221001094225145.png)



# 武器

## 绑定手部模型

打开这个网格体

![image-20221001095559471](assets/image-20221001095559471.png)

添加一个插槽

![image-20221001095640158](assets/image-20221001095640158.png)

给这个插槽添加一把枪（图中已经加了

![image-20221001095716253](assets/image-20221001095716253.png)

重命名成HandSocket

![image-20221001100214516](assets/image-20221001100214516.png)

把枪移动到合适的位置

![image-20221001095745931](assets/image-20221001095745931.png)

可以打开上面提到的Arms_idle来校准枪的位置

![image-20221001100946488](assets/image-20221001100946488.png)

打开FPS_Character，创建一把枪

![image-20221001095840698](assets/image-20221001095840698.png)

在Construction Scripts里将枪和手关联起来

![image-20221001101047224](assets/image-20221001101047224.png)



## 瞄准

打开FPS_AnimBP，创建一个变量

![image-20221001102326173](assets/image-20221001102326173.png)

添加操作映射

![image-20221001102423373](assets/image-20221001102423373.png)

打开FPS_Character的事件图表，创建如下蓝图

![image-20221001102401394](assets/image-20221001102401394.png)

配置瞄准动画

上面配置了Idle和Walking的状态，这里需要改一下，把Idle和Walking的状态剪切一下，等会用。先创建这两个状态

![image-20221001104409732](assets/image-20221001104409732.png)

在Aim状态中创建一个状态机

![image-20221001104436409](assets/image-20221001104436409.png)

把Idle和Walking的状态粘贴过来，并改名

![image-20221001104502767](assets/image-20221001104502767.png)

改一下对应的序列播放器

![image-20221001104524039](assets/image-20221001104524039.png)

![image-20221001104537455](assets/image-20221001104537455.png)

Not Aiming也是一样

![image-20221001104557623](assets/image-20221001104557623.png)

![image-20221001104606176](assets/image-20221001104606176.png)

Not Aiming的序列播放器不用改

这样就做好了瞄准和没瞄准的动画了

如果你觉得运行起来的时候，瞄准状态里的枪的位置有点高，可以这样调整一下

![image-20221001104737400](assets/image-20221001104737400.png)

调完了别忘了改回自己的动画蓝图



## 弹出弹壳

加一个开火控制

![image-20221001113418104](assets/image-20221001113418104.png)

创建一个场景组件，命名为Burst Point

![image-20221001113450580](assets/image-20221001113450580.png)

摆正位置（注意绿标的朝向

![image-20221001113556769](assets/image-20221001113556769.png)

如果发现枪口一直在动，可以暂停动画，注意调整完了之后要继续打开动画

![image-20221001113647565](assets/image-20221001113647565.png)

然后在事件图表中写这么一段蓝图，注意Emitter Template的引用 

![image-20221001113715644](assets/image-20221001113715644.png)

如果你发现每次点击，都会发射三发子弹，可以通过如下方式来调整

打开P_BelicaMuzzle

![image-20221001114128876](assets/image-20221001114128876.png)

删除到只剩一个

![image-20221001114214270](assets/image-20221001114214270.png)

![image-20221001114312188](assets/image-20221001114312188.png)

![image-20221001114446733](assets/image-20221001114446733.png)

![image-20221001114346522](assets/image-20221001114346522.png)

前面几个也是类似

加一个音效

![image-20221001115522995](assets/image-20221001115522995.png)



## 开火动画

开火的时候给手臂加点动画

![image-20221001120341179](assets/image-20221001120341179.png)

![image-20221001120410399](assets/image-20221001120410399.png)

命名为FireMontage

打开这个

![image-20221001121403874](assets/image-20221001121403874.png)

创建一个新插槽

![image-20221001121430837](assets/image-20221001121430837.png)

选择新插槽

![image-20221001121501989](assets/image-20221001121501989.png)

拖过来

![image-20221001121518168](assets/image-20221001121518168.png)

改一下混入混出时间

![image-20221001121547240](assets/image-20221001121547240.png)

在FPS_AnimBP中加入这个蒙太奇

![image-20221001121634056](assets/image-20221001121634056.png)

然后在FPS_Character中播放蒙太奇

![image-20221001121716176](assets/image-20221001121716176.png)

保存运行，就可以看到开枪的时候有手部抖动的效果

再创建一个新的蒙太奇，叫AimFireMontage

![image-20221005162651399](assets/image-20221005162651399.png)

修改FPS_Character

![image-20221005162708444](assets/image-20221005162708444.png)



## 整理代码

整理一下FPS_Character的代码，将之整合为三个函数

![image-20221005163329982](assets/image-20221005163329982.png)

![image-20221005163346451](assets/image-20221005163346451.png)

![image-20221005163405572](assets/image-20221005163405572.png)

![image-20221005163434021](assets/image-20221005163434021.png)

## 击中效果

本质是在射击的同时发出一条追踪线，检测击中的位置，然后播放一个击中的效果即可

![image-20221005164707144](assets/image-20221005164707144.png)



# 敌人

创建一个Pawn类，命名为DronePawn

![image-20221005164945773](assets/image-20221005164945773.png)

创建一个骨骼网格体，把对应的资产放进去

![image-20221005171413157](assets/image-20221005171413157.png)

在细节窗口继续往下滑，修改碰撞预设

![image-20221005171504909](assets/image-20221005171504909.png)



## 击中效果

首先配置击中时的音效，先导入初学者内容包

![image-20221005170158730](assets/image-20221005170158730.png)

![image-20221005170210645](assets/image-20221005170210645.png)

创建音效衰减，命名为Drone_att

![image-20221005170259726](assets/image-20221005170259726.png)

![image-20221005170355837](assets/image-20221005170355837.png)

打开这个

**![image-20221005170419948](assets/image-20221005170419948.png)**

![image-20221005170438412](assets/image-20221005170438412.png)

这样的话就混合了两个音效，有回声，比较像真实的爆炸效果

接着导入一个新的资产，使用里面的爆炸效果

![image-20221005171640779](assets/image-20221005171640779.png)

给DronePawn创建一个Explode函数

![image-20221005171727700](assets/image-20221005171727700.png)

注意粒子系统，别用错了

![image-20221005171806462](assets/image-20221005171806462.png)

然后在FPS_Character中补充对应的逻辑

![image-20221005171849178](assets/image-20221005171849178.png)

可以把这个Actor拖到场景里，体验一下效果

![image-20221005171954015](assets/image-20221005171954015.png)



## 自动寻路

给Drone添加一个Sphere碰撞体，如果玩家进入这个Sphere，就自动锁定玩家，并朝玩家所在位置飞过去

创建Sphere并调整大小，可以搞大点

![image-20221005173527846](assets/image-20221005173527846.png)

设置在游戏里可见（这里是方便调试，正式导出的时候可以关掉）

![image-20221005175147208](assets/image-20221005175147208.png)

添加导航组件，放到路面上，按p建，会发现与地面重合的部分变绿了，绿的部分就说明可以导航

![image-20221005175215595](assets/image-20221005175215595.png)

然后把这个导航网格疯狂放大，直到能覆盖所有的路面![image-20221005175420913](assets/image-20221005175420913.png)

如果发现有路沿没办法被覆盖，可以调整一下项目设置

![image-20221005174122883](assets/image-20221005174122883.png)

调整好之后再按一下P键就可以让绿色消失了

接下来给Drone创建一个移动组件

![image-20221005174403615](assets/image-20221005174403615.png)

补充蓝图

![image-20221005175643156](assets/image-20221005175643156.png)

就可以实现追踪的效果了

再创建一个小一点的ExplodeSphere

![image-20221005180020986](assets/image-20221005180020986.png)

当玩家与ExplodeSphere碰撞的时候，就发生爆炸

![image-20221005180057393](assets/image-20221005180057393.png)

但是有个问题，当你绕到背后的时候，会发现Drone是背对着你飞过来的，这明显不对，我们还需要调整一下

首先摆正网格体的位置，让正面朝向绿色的标

![image-20221005182355528](assets/image-20221005182355528.png)

然后补充如下蓝图

![image-20221005182412917](assets/image-20221005182412917.png)



## 巡逻

创建一个Actor，命名为PatrolPoint，也叫巡逻点，主要用于定位，不用写什么功能

![image-20221005183442175](assets/image-20221005183442175.png)

为了确认在游戏中的位置，可以加一些调试代码

![image-20221005190611159](assets/image-20221005190611159.png)

在场景里加上两个巡逻点

![image-20221005190844235](assets/image-20221005190844235.png)

然后互相指定为对方的NextPoint

![image-20221005190928883](assets/image-20221005190928883.png)

然后修改DronePawn的变量，并添加如下代码

![image-20221005191038559](assets/image-20221005191038559.png)

并在场景中指定DronePawn的GoalActor为某一个巡逻点

![image-20221005191214863](assets/image-20221005191214863.png)

这些个操作的主要原理是：设定GoalActor为初始巡逻点，然后敌机就会在游戏启动的时候移动过去，移动到巡逻点之后，会将GoalActor设置为下一个巡逻点，然后继续移动，如此往复。当玩家进入敌机范围时，又会将GoalActor设置为玩家，然后循环就打断了，敌机开始向玩家移动



## 碰撞优化

这里我们有蛮多碰撞的检测体，如果敌机的数量变多，那碰撞的次数也会变多，会无端的消耗性能，所以我们可以做一些优化

![image-20221005195649499](assets/image-20221005195649499.png)

![image-20221005195704544](assets/image-20221005195704544.png)

![image-20221005195806546](assets/image-20221005195806546.png)

![image-20221005195822444](assets/image-20221005195822444.png)



# 用户界面

创建一个控件蓝图，命名为CharacterHUD

![image-20221006112736585](assets/image-20221006112736585.png)



## 准心

![image-20221006113421769](assets/image-20221006113421769.png)

注意，，锚点需要配置在中央

![image-20221006113454555](assets/image-20221006113454555.png)

此时运行游戏，就能发现中间有个准心了

然后发现瞄准状态的时，准心和枪的位置不在一起，需要调整

![image-20221006115858980](assets/image-20221006115858980.png)

在这个状态下调整抢的位置，能够实时反映到游戏窗口，调整好之后切换回去就可以了



## 敌机血条

目前我们是一下就能把敌机打爆，现在需要设置敌机血条和我们的伤害值，要多打几下才能打爆

![image-20221006143755837](assets/image-20221006143755837.png)

![image-20221006143831772](assets/image-20221006143831772.png)

这一堆代码不好看，可以把后面关于巡逻的代码折叠成一个宏

![image-20221006144255271](assets/image-20221006144255271.png)



## 玩家血条

在Character中添加一个进度条

![image-20221006144755410](assets/image-20221006144755410.png)

修改敌机代码

![image-20221006150314919](assets/image-20221006150314919.png)

修改FPS_Character

![image-20221006150354836](assets/image-20221006150354836.png)

因为一个函数的代码量有点多，所以这里折叠了蛮多代码，细节如下

![image-20221006150503379](assets/image-20221006150503379.png)

![image-20221006150517831](assets/image-20221006150517831.png)



# 小优化

## 子弹连发

把FPS_Character中的这些代码都折叠成函数FireWeapon

![image-20221006151214227](assets/image-20221006151214227.png)

![image-20221006152800830](assets/image-20221006152800830.png)

FireWeapon也要改一下

![image-20221006152840102](assets/image-20221006152840102.png)



## 弹药限制

限制子弹数量，不能无限多

![image-20221006160326592](assets/image-20221006160326592.png)

**注意这里两个文本的锚点都需要设在右下方，不然显示不出来的，还有两个文本变量的命名，后面要用到**

在开始运行时，设置弹药数量

![image-20221006161004911](assets/image-20221006161004911.png)

在开火时检测弹药数量，开火完后减去弹药数量

![image-20221006161053507](assets/image-20221006161053507.png)



## 补充弹药

创建一个Actor蓝图，命名为AmmoPickup

![image-20221006161423417](assets/image-20221006161423417.png)

![image-20221006162202261](assets/image-20221006162202261.png)

在FPS_Character中创建一个函数

![image-20221006180428462](assets/image-20221006180428462.png)

在AmmoPickup中调用

![image-20221006162313755](assets/image-20221006162313755.png)

然后将这个Actor放入场景就可以了

加一点旋转动画

![image-20221006232108297](assets/image-20221006232108297.png)



## 激怒敌机

修改DronePawn代码，新增一个自定义事件

![image-20221006163942021](assets/image-20221006163942021.png)

然后在FPS_Character中应用一下

![image-20221006164014045](assets/image-20221006164014045.png)

这里还希望，当敌机被激怒的时候会变红，实现过程如下：

给敌机创建一个材质实例

![image-20221006181615716](assets/image-20221006181615716.png)

可以看到这里用于控制颜色的字段是TeamColor

![image-20221006182501932](assets/image-20221006182501932.png)

我们需要在游戏运行的时候给他创建动态的材质实例

打开DronePawn的构造脚本，编写如下蓝图

![image-20221006182610520](assets/image-20221006182610520.png)

然后在事件图表中稍作修改即可

![image-20221006182707637](assets/image-20221006182707637.png)



## 治疗

创建一个Actor，命名为HealthPickup

![image-20221006181138244](assets/image-20221006181138244.png)

![image-20221006181208014](assets/image-20221006181208014.png)

在FPS_Character中创建一个函数

![image-20221006181253403](assets/image-20221006181253403.png)

在HealthPickup中调用

![image-20221006181229442](assets/image-20221006181229442.png)

加一点旋转动画

![image-20221006232137954](assets/image-20221006232137954.png)



# 游戏模式

创建FPSGameMode

![image-20221006183257367](assets/image-20221006183257367.png)

![image-20221006185600933](assets/image-20221006185600933.png)

![image-20221006185612263](assets/image-20221006185612263.png)



## 剩余敌机

创建一个新的控件蓝图GameModeHUD，四个文本的锚点都在右上方，DronesText 和 TimeText 都要提升为变量

![image-20221006185708952](assets/image-20221006185708952.png)

编写FPSGameMode蓝图代码

![image-20221006185917873](assets/image-20221006185917873.png)

创建一个击败敌机的函数

![image-20221006185954808](assets/image-20221006185954808.png)

在敌机爆炸的时候调用

![image-20221006190058824](assets/image-20221006190058824.png)



## 热身时间

在游戏开始之前，有3秒钟的倒计时，此时玩家不能打也不能动，3秒之后再开始

由此我们需要管理一下游戏状态，创建如下枚举，命名为SessionState

![image-20221006212900052](assets/image-20221006212900052.png)

枚举内容如下

![image-20221006213203617](assets/image-20221006213203617.png)

修改GameModeHUD

![image-20221006215856931](assets/image-20221006215856931.png)

打开FPSGameMode，按顺序编写蓝图

![image-20221006215535452](assets/image-20221006215535452.png)

![image-20221006215611856](assets/image-20221006215611856.png)

![image-20221006215646498](assets/image-20221006215646498.png)

优化一下FPSGameMode的事件开始运行时

![image-20221006215801809](assets/image-20221006215801809.png)

![image-20221006220021830](assets/image-20221006220021830.png)



## 游戏倒计时

给GameModeHUD加上文本组件

![image-20221006224138331](assets/image-20221006224138331.png)

按照顺序编写FPSGameMode蓝图

![image-20221006224449494](assets/image-20221006224449494.png)

![image-20221006224525787](assets/image-20221006224525787.png)

![image-20221006224547413](assets/image-20221006224547413.png)

![image-20221006224608593](assets/image-20221006224608593.png)

![image-20221006224647843](assets/image-20221006224647843.png)

如果倒计时在10秒内就变红

![image-20221006230616929](assets/image-20221006230616929.png)



## 游戏输赢

玩家赢了

![image-20221006230031692](assets/image-20221006230031692.png)

![image-20221006230120997](assets/image-20221006230120997.png)

玩家被打死了

![image-20221006230052253](assets/image-20221006230052253.png)

![image-20221006230220073](assets/image-20221006230220073.png)



## 收尾

![image-20221006232225054](assets/image-20221006232225054.png)

![image-20221006232307116](assets/image-20221006232307116.png)
